import fetch from "node-fetch";
import WebSocket, { WebSocketServer } from "ws";
import xhr2Pkg from "xhr2";
import centrifugePkg from "centrifuge";
import express from "express";
import fs from "fs";
import path from "path";
import http from "http";
import { fileURLToPath } from "url";

const { XMLHttpRequest } = xhr2Pkg;
const Centrifuge =
    centrifugePkg.default?.Centrifuge ||
    centrifugePkg.Centrifuge ||
    centrifugePkg.default ||
    centrifugePkg;

global.WebSocket = WebSocket;
global.XMLHttpRequest = XMLHttpRequest;
global.fetch = fetch;

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const SETTINGS_FILE = path.join(process.cwd(), "settings.json");

// === —Å–æ–∑–¥–∞—ë–º settings.json, –µ—Å–ª–∏ –Ω–µ—Ç ===
if (!fs.existsSync(SETTINGS_FILE)) {
    fs.writeFileSync(
        SETTINGS_FILE,
        JSON.stringify(
            {
                ACCESS_TOKEN: "",
                USER_ID: "",
                TSHOCK_API: "http://127.0.0.1:25565",
                TOKEN: "123456",
                COMMANDS: [
                    { min: 50, mode: "all", commands: ["say –°–ø–∞—Å–∏–±–æ {name} –∑–∞ –¥–æ–Ω–∞—Ç {sum} —Ä—É–±–ª–µ–π!"] },
                    { min: 100, mode: "random:1", commands: ["spawnmob zombie", "spawnmob slime"] },
                ],
                ADVANCED: {
                    autoStart: true,
                    logLevel: "info",
                    checkInterval: 30,
                    backupInterval: 60,
                },
            },
            null,
            2
        )
    );
}

let settings = JSON.parse(fs.readFileSync(SETTINGS_FILE, "utf-8"));
let BASE_URL = "";

const app = express();
const server = http.createServer(app);
const wsClients = new Set();

app.use(express.json());
app.use(express.static(path.join(__dirname, "../web")));

// API Routes
app.get("/api/settings", (req, res) => {
    res.json(settings);
});

app.post("/api/settings", async (req, res) => {
    try {
        settings = { ...settings, ...req.body };

        // –û–±–Ω–æ–≤–ª—è–µ–º BASE_URL –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ TSHOCK_API
        if (req.body.TSHOCK_API) {
            BASE_URL = `${settings.TSHOCK_API}/v3/server/rawcmd?cmd=/sudo%20Bebrok%20`;
        }

        fs.writeFileSync(SETTINGS_FILE, JSON.stringify(settings, null, 2));
        logToClients("üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
        res.json({ success: true, message: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã" });
    } catch (error) {
        res.status(500).json({ success: false, message: error.message });
    }
});

app.get("/api/status", async (req, res) => {
    try {
        const terrariaStatus = await checkTShockStatus();
        res.json({
            terraria: terrariaStatus ? "online" : "offline",
            donatepay: currentStatus.donatepay,
            bot: currentStatus.bot
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

app.post("/api/restart", (req, res) => {
    logToClients("üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞...");
    setTimeout(() => {
        startBot();
        res.json({ success: true, message: "–°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω" });
    }, 1000);
});

const WEB_PORT = process.env.PORT || 8080;
server.listen(WEB_PORT, "0.0.0.0", () => {
    console.log(`üåê –ü–∞–Ω–µ–ª—å BDPTI –∑–∞–ø—É—â–µ–Ω–∞: http://localhost:${WEB_PORT}`);
    console.log(`üìÅ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑: ${path.join(__dirname, "../web")}`);
});

// WebSocket –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
const wss = new WebSocketServer({ server });
wss.on("connection", (ws) => {
    wsClients.add(ws);
    ws.send(JSON.stringify({
        type: "status",
        data: currentStatus
    }));

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –ª–æ–≥–∏ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
    recentLogs.forEach(log => {
        ws.send(JSON.stringify({ type: "log", data: log }));
    });

    ws.on("close", () => wsClients.delete(ws));
    ws.on("error", () => wsClients.delete(ws));
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è BASE_URL
BASE_URL = `${settings.TSHOCK_API}/v3/server/rawcmd?cmd=/sudo%20Bebrok%20`;

const currentStatus = {
    terraria: "unknown",
    donatepay: "unknown",
    bot: "starting",
};

const recentLogs = [];
const MAX_LOG_HISTORY = 1000;

function updateStatus(part, state) {
    currentStatus[part] = state;
    const message = JSON.stringify({ type: "status", data: currentStatus });

    wsClients.forEach(ws => {
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(message);
        }
    });
}

function logToClients(msg) {
    const timestamp = new Date().toLocaleTimeString();
    const fullMessage = `[${timestamp}] ${msg}`;

    console.log(fullMessage);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
    recentLogs.push(fullMessage);
    if (recentLogs.length > MAX_LOG_HISTORY) {
        recentLogs.shift();
    }

    const message = JSON.stringify({ type: "log", data: fullMessage });

    wsClients.forEach(ws => {
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(message);
        }
    });
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ Terraria —Å–µ—Ä–≤–µ—Ä–∞
async function checkTShockStatus() {
    try {
        const res = await fetch(`${settings.TSHOCK_API}/v2/server/status?token=${settings.TOKEN}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        updateStatus("terraria", "online");
        return true;
    } catch (error) {
        updateStatus("terraria", "offline");
        return false;
    }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ Terraria
async function sendToTShock(cmd) {
    try {
        const encoded = encodeURIComponent(cmd);
        const url = `${BASE_URL}${encoded}&token=${settings.TOKEN}`;
        const res = await fetch(url);

        if (res.ok) {
            logToClients(`‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${cmd}`);
            return true;
        } else {
            logToClients(`‚ö†Ô∏è –û—à–∏–±–∫–∞ (${res.status}) –ø—Ä–∏ –∫–æ–º–∞–Ω–¥–µ: ${cmd}`);
            return false;
        }
    } catch (error) {
        logToClients(`üö´ –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`);
        return false;
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ DonatePay
async function getSocketToken() {
    try {
        const res = await fetch("https://donatepay.ru/api/v2/socket/token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ access_token: settings.ACCESS_TOKEN }),
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        return data.token;
    } catch (error) {
        logToClients(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ DonatePay: ${error.message}`);
        throw error;
    }
}

// –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–æ—Ç–∞
async function startBot() {
    logToClients("üîÑ –ó–∞–ø—É—Å–∫ BDPTI –±–æ—Ç–∞...");
    updateStatus("bot", "starting");

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º Terraria —Å–µ—Ä–≤–µ—Ä
    logToClients("üîç –ü—Ä–æ–≤–µ—Ä—è—é Terraria —Å–µ—Ä–≤–µ—Ä...");
    const terrariaOnline = await checkTShockStatus();

    if (!terrariaOnline) {
        logToClients("‚ö†Ô∏è Terraria —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ë–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è.");
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ DonatePay
    if (!settings.ACCESS_TOKEN || !settings.USER_ID) {
        logToClients("‚ùå –£–∫–∞–∂–∏—Ç–µ DonatePay Token –∏ User ID –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö!");
        updateStatus("bot", "stopped");
        updateStatus("donatepay", "offline");
        return;
    }

    logToClients("üîó –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ DonatePay...");
    updateStatus("donatepay", "connecting");

    try {
        const token = await getSocketToken();

        const centrifuge = new Centrifuge("wss://centrifugo.donatepay.ru/connection/websocket", {
            subscribeEndpoint: "https://donatepay.ru/api/v2/socket/token",
            subscribeParams: { access_token: settings.ACCESS_TOKEN },
            disableWithCredentials: true,
        });

        centrifuge.setToken(token);
        const channel = `$public:${settings.USER_ID}`;

        logToClients(`üì° –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª: ${channel}`);

        centrifuge.subscribe(channel, async (message) => {
            const vars = message?.data?.notification?.vars;
            if (!vars) return;

            const name = vars.name || "–ê–Ω–æ–Ω–∏–º";
            const amount = parseFloat(vars.sum) || 0;
            const msg = vars.comment || "";

            logToClients(`üí∞ –î–æ–Ω–∞—Ç –æ—Ç ${name} ‚Äî ${amount}‚ÇΩ: ${msg}`);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Terraria –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∫–æ–º–∞–Ω–¥
            const isTerrariaOnline = await checkTShockStatus();
            if (!isTerrariaOnline) {
                logToClients("‚ö†Ô∏è Terraria —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∫–æ–º–∞–Ω–¥—ã –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã");
                return;
            }

            // –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã –ø–æ —É—Å–ª–æ–≤–∏—è–º
            try {
                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–æ —Å—É–º–º–µ –±–ª–æ–∫–∏
                const eligibleActions = settings.COMMANDS
                    .filter(action => amount >= action.min)
                    .sort((a, b) => b.min - a.min); // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é min

                if (eligibleActions.length === 0) {
                    logToClients(`‚ö†Ô∏è –ù–µ—Ç –∫–æ–º–∞–Ω–¥ –¥–ª—è —Å—É–º–º—ã ${amount}‚ÇΩ`);
                    return;
                }

                // –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —Å–∞–º—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π (—Å –Ω–∞–∏–±–æ–ª—å—à–∏–º min)
                const action = eligibleActions[0];
                let commandsToExecute = [...action.commands];

                // –ï—Å–ª–∏ —Ä–µ–∂–∏–º random ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
                if (action.mode && action.mode.startsWith("random")) {
                    const count = parseInt(action.mode.split(":")[1]) || 1;
                    commandsToExecute = commandsToExecute
                        .sort(() => Math.random() - 0.5)
                        .slice(0, count);
                }

                // –í—ã–ø–æ–ª–Ω—è–µ–º –∫–∞–∂–¥—É—é –∫–æ–º–∞–Ω–¥—É –ø–æ –æ—á–µ—Ä–µ–¥–∏
                for (const cmd of commandsToExecute) {
                    const processedCmd = cmd
                        .replace(/{name}/g, name)
                        .replace(/{sum}/g, amount)
                        .replace(/{msg}/g, msg);

                    await sendToTShock(processedCmd);
                    await new Promise(resolve => setTimeout(resolve, 100)); // –Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                }

                logToClients(`‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω –Ω–∞–±–æ—Ä –∫–æ–º–∞–Ω–¥ –¥–ª—è –¥–æ–Ω–∞—Ç–∞ ${amount}‚ÇΩ (min: ${action.min})`);
            } catch (err) {
                logToClients(`üö´ –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–æ–Ω–∞—Ç–∞: ${err.message}`);
            }
        });

        centrifuge.on("connect", () => {
            logToClients("‚úÖ DonatePay –ø–æ–¥–∫–ª—é—á–µ–Ω");
            updateStatus("donatepay", "online");
            updateStatus("bot", "running");
        });

        centrifuge.on("disconnect", () => {
            logToClients("‚ùå DonatePay –æ—Ç–∫–ª—é—á–µ–Ω");
            updateStatus("donatepay", "offline");
            updateStatus("bot", "error");
        });

        centrifuge.on("error", (error) => {
            logToClients(`‚ö†Ô∏è –û—à–∏–±–∫–∞ DonatePay: ${error.message}`);
            updateStatus("donatepay", "error");
        });

        centrifuge.connect();

    } catch (error) {
        logToClients(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ DonatePay: ${error.message}`);
        updateStatus("donatepay", "error");
        updateStatus("bot", "error");
    }
}

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
setInterval(async () => {
    await checkTShockStatus();
}, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
startBot();

// –û–±—Ä–∞–±–æ—Ç–∫–∞ graceful shutdown
process.on('SIGINT', () => {
    logToClients("üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ BDPTI –±–æ—Ç–∞...");
    process.exit(0);
});